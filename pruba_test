import ast
import os
import random
# -----------------------------
# usuario
nombre = ""
segundo_nombre = ""
apellido_p = ""
apellido_m = ""
crear_usuario = {}
clave = ""
clave_confirmar = True
clave_confirmada = " "
# -----------------------------
# variables generales
haymasopciones = True
intentos = 3
opciones = ""
resp = ""
contador = 0
mes = 0
opcion = ""
noesfindejornada = True
dia = 0
# -----------------------------
# variables colaborador
bar = ""
clave_bar = ""
bar_1 = "Tomas"
bar_2 = "Agustin"
clave_bar1 = "1234"
clave_bar2 = "5678"
horario_1 = {}  # Diccionario para Agustin
horario_2 = {}  # Diccionario para Tomas
ver_horario = ""
mod = ""
hora = 0
nueva_hora = 0
hora_real = 0
cambio_hora = 0
# -----------------------------
# atencion al cliente
correo = ""
nombre_mail = ""
# -----------------------------
# tipo de pago
rut = ""
tipo_pago = 0
tarjeta = 1
efectivo = 2
guardar_boleta = {}
boleta = 0
# ----------------------------
# funciones

def print_horas():
    print("1- 9:00")
    print("2- 10:00")
    print("3- 11:00")
    print("4- 12:00")
    print("5- 13:00")
    print("6- 14:00")
    print("7- 15:00")
    print("8- 16:00")
    print("9- 17:00")
    print("10- 18:00")
    print("Seleccione su hora (entre 9:00 y 18:00 horas)")

def seleccionar_tipo_pago(nombre, boleta, rut, guardar_boleta):
    while True:
        print("Ingrese tipo de pago: ")
        print("1- Efectivo \n2- Tarjeta")
        tipo_pago = input()
        if tipo_pago == "1":
            print("Si deseas pagar con efectivo, contáctate con nosotros en la opción 5.")
            print("Hasta luego {}".format(nombre))
            return False
        elif tipo_pago == "2":
            print("Perfecto, {}".format(nombre))
            boleta = random.randint(1000,9999)
            print(boleta)
            print("Su boleta es: {}".format(boleta))
            guardar_boleta= {
                "nombre": nombre,
                "boleta": boleta
            }
            print("¡Gracias por su consulta!")
            return False
        else:
            print("Tipo de pago inválido, intente nuevamente.")

def mostrar_horario(horario):
    if not horario:
        print("No tienes horas agendadas.")
    else:
        for clave, value in horario.items():
            mes, dia, hora = clave
            print("Mes: {}, Día: {}, Hora: {}:00 → Nueva hora: {}:00".format(mes, dia, hora, value))

def modificar_horario(horario):
    mostrar_horario(horario)
    print("Ingrese el mes que desea modificar: ")
    mes = int(input())
    print("Ingrese el día a modificar: ")
    dia = int(input())
    print("Ingrese la hora que desea modificar: ")
    hora = int(input())
    clave = (mes, dia, hora)
    if clave in horario:
        print("Ingrese la nueva hora: ")
        nueva_hora = int(input())
        horario[clave] = nueva_hora
        print("Horario modificado con éxito!")
        mostrar_horario(horario)
    else:
        print("La hora que quiere modificar no existe en su horario.")

def flujo_colaborador(nombre_colab, clave_colab, horario):
    intentos = 3
    while True:
        if bar == nombre_colab:
            print("Ingrese la clave: ")
            clave_bar = input()
            if clave_bar == clave_colab:
                print("Bienvenido {}!".format(nombre_colab))
                print("Tu horario es de 9:00 a 18:00.")
                print("¿Quieres ver tus horas agendadas? (si/no)")
                ver_horario = input().lower()
                if ver_horario == "si":
                    print("Estas son tus horas agendadas: ")
                    mostrar_horario(horario)
                    print("¿Quieres modificar tu horario? (si/no)")
                    mod = input().lower()
                    if mod == "si":
                        modificar_horario(horario)
                    elif mod == "no":
                        print("No se ha modificado el horario")
                        return False     
                    else:
                        print("Opción inválida, no se ha modificado el horario")
                        return False
                else:
                    print("Hasta luego!")
                    return False
            else:
                intentos -= 1
                if intentos == 0:
                    print("Se han agotado los intentos, vuelva a intentarlo más tarde")
                    haymasopciones = False
                print("Le quedan {} intentos".format(intentos))
        else:
            print("Nombre de colaborador incorrecto")
            haymasopciones = False

# -----------------------------
print("Bienvenido!")

# Cargar usuarios guardados si existen (cada usuario en una línea, usando ast)
crear_usuario = {}
if os.path.exists("usuarios.txt"):
    with open("usuarios.txt") as file:
        for line in file:
            if line.strip():
                try:
                    rut, datos = line.strip().split(":", 1)
                    usuario_dict = ast.literal_eval(datos.strip())
                    # Asegura que todos tengan 'num_usuario'
                    if "num_usuario" not in usuario_dict:
                        usuario_dict["num_usuario"] = len(crear_usuario) + 1
                    crear_usuario[rut.strip()] = usuario_dict
                except Exception as e:
                    print("Error al leer usuario en línea: {}\nError específico: {}".format(line.strip(), e))

while noesfindejornada:
    print("Ingrese la opcion deseada: ")
    print("1- Crear cuenta")
    print("2- Iniciar sesion")
    print("3- Ingreso de colaboradores")
    print("4- Agenda")
    print("5- Atencion al cliente")
    print("6- Salir\n")
    print("Ingrese: ")
    opcion = input()

    if opcion == "1":
        haymasopciones = True
        while haymasopciones:
            print("Ingrese primer nombre del usuario: ")
            nombre = input()
            print("Ingrese segundo nombre: ")
            segundo_nombre = input()
            print("Ingrese apellido paterno: ")
            apellido_p = input()
            print("Ingrese apellido materno: ")
            apellido_m = input()
            print("Ingrese clave: ")
            clave = input()
            print("Ingrese rut: ")
            rut = input().strip()           
            if rut in crear_usuario:
                print("Ya existe un usuario registrado con ese rut.")
                haymasopciones = False
            else:
                while clave_confirmar:
                    print("Confirme su clave: ")
                    clave_confirmada = input()
                    if clave == clave_confirmada:
                        print("Clave confirmada")
                        clave_confirmar = False
                        crear_usuario[rut] = {
                            "nombre": nombre,
                            "segundo_nombre": segundo_nombre,
                            "apellido_p": apellido_p,
                            "apellido_m": apellido_m,
                            "clave": clave,
                        }
                        with open("usuarios.txt", "w") as file:
                            for rut_guardar, datos in crear_usuario.items():
                                file.write("{}: {}\n".format(rut_guardar, datos))
                        print("Usuarios guardados en usuarios.txt")
                        haymasopciones = False
                    else:
                        print("Las claves no coinciden, intente nuevamente")
    elif opcion == "2":
        haymasopciones = True
        intentos = 3
        while haymasopciones:
            print("Ingrese su rut: ")
            rut = input().strip()
            print("Ingrese su clave: ")
            clave = input()
            if not crear_usuario:
                print("No hay usuarios registrados, por favor registrese primero")
                haymasopciones = False
            elif rut in crear_usuario and clave == crear_usuario[rut]["clave"]:
                print("Bienvenido de nuevo!")
                haymasopciones = False
            else:
                print("Usuario o clave incorrecta, intente nuevamente")
                intentos -= 1
                if intentos == 0:
                    print("Se han agotado los intentos, vuelva a intentarlo más tarde")
                    haymasopciones = False
                else:
                    print("Le quedan {} intentos".format(intentos))
    elif opcion == "3":
        while haymasopciones: 
            print("Ingreso de colaboradores ({}/{}), si desea volver al menu apriete enter".format(bar_1, bar_2))
            bar = input()
            if bar == bar_1:
                flujo_colaborador(bar_1, clave_bar1, horario_1)
            elif bar == bar_2:
                flujo_colaborador(bar_2, clave_bar2, horario_2)
            else:
                haymasopciones =False


    elif opcion == "4":
        haymasopciones = True
        while haymasopciones:
            if not crear_usuario:
                print("Debe iniciar sesión primero.")
                haymasopciones = False
            print("Ingrese su rut para agendar: ")
            rut = input().strip()
            if rut in crear_usuario:
                print("Bienvenido a la agenda de horarios!\n")
                print("{}, ¿desea agendar con Tomas o Agustin? (Tomas/Agustin)".format(crear_usuario[rut]['nombre']))
                bar = input()
                if bar == "Agustin":
                    horario = horario_1
                elif bar == "Tomas":
                    horario = horario_2
                else:
                    print("Colaborador inválido.")
                    continue

                print("Ingrese el mes en el cual desea agendar (entre 1 y 12): ")
                mes = int(input())
                if 1 <= mes <= 12:
                    if mes == 2:
                        max_dia = 28
                    elif mes in [4, 6, 9, 11]:
                        max_dia = 30
                    else:
                        max_dia = 31
                    print("Ingrese el día (entre 1 y {}): ".format(max_dia))
                    dia = int(input())
                    if 1 <= dia <= max_dia:
                        print_horas()
                        hora = int(input())
                        if 1 <= hora <= 10:
                            hora_real = hora + 8
                            print("{} su hora agendada es: {}-{}-2025 a las {}:00".format(crear_usuario[rut]['nombre'], dia, mes, hora_real))
                            clave_horario = (mes, dia, hora_real)
                            if clave_horario in horario:
                                print("La hora ya fue agendada, por favor intente nuevamente.")
                            else:
                                horario[clave_horario] = hora_real
                                print("Ingrese rut: ")
                                rut_boleta = input()
                                seleccionar_tipo_pago(crear_usuario[rut]['nombre'], boleta, rut_boleta, guardar_boleta)
                        else:
                            print("Hora inválida.")
                    else:
                        print("Día inválido.")
                else:
                    print("Mes inválido.")
            else:
                print("Debe iniciar sesión primero.")
                haymasopciones = False

    elif opcion == "5":
        print("Ingrese su correo:")
        correo = input()
        print("Ingrese su nombre:")
        nombre_mail = input()
        print("Nos contactaremos muy pronto con usted {}".format(nombre_mail))
        print("¡Gracias por su consulta!")

    elif opcion == "6":
        noesfindejornada = False
        print("Hasta pronto!")
    else:
        print("\nOpción inválida, intente nuevamente\n")

print("Las boletas generadas son: ")
for i in guardar_boleta:
    print(i)
print("Las horas agendadas con Agustin son: ")
for k, v in horario_1.items():
    print("Mes: {}, Día: {}, Hora: {} → Nueva hora: {}".format(k[0], k[1], k[2], v))
print("Las horas agendadas con Tomas son: ")
for k, v in horario_2.items():
    print("Mes: {}, Día: {}, Hora: {} → Nueva hora: {}".format(k[0], k[1], k[2], v))
